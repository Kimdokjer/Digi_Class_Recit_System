<?php
session_start();

if (!isset($_SESSION['loggedin']) || $_SESSION['user_role'] !== 'admin') {
    header("Location: login.php");
    exit;
}

require_once "../classes/studentmanager.php";
$manager = new studentmanager();

$student_form_data = [];
$add_student_errors = [];
$score_errors = [];
$score_success = false;
$maxScore = 10;
$totalPossibleRecitations = 10;

$sort_order = $_GET['sort'] ?? 'asc';
$sort_column = $_GET['sort_col'] ?? 'lastName';
$selected_class_filter = $_GET['class_filter'] ?? 'all';
$search_query = trim($_GET['search_query'] ?? '');
$current_section = $_GET['section'] ?? 'dashboard';

// --- Variables for Report Generation ---
$report_students = [];
$report_class_details = null;
$report_student_details = null;
$report_student_subjects = [];
$report_class_name = $_GET['report_class_name'] ?? '';
$report_student_id = $_GET['report_student_id'] ?? '';


$dashboard_stats = [];
// Variables for Charts
$chart_engaged = 0;
$chart_total = 0;
$chart_labels_json = '[]';
$chart_data_json = '[]';

try {
    $conn = $manager->connect();
    
    if ($current_section === 'dashboard') {
        // 1. Basic Stats
        $stmt_students = $conn->query("SELECT COUNT(student_id) AS totalStudents FROM students");
        $dashboard_stats['totalStudents'] = $stmt_students->fetchColumn();
        $chart_total = $dashboard_stats['totalStudents'];
        
        $stmt_recitations = $conn->query("SELECT COUNT(recit_id) AS totalRecitations, AVG(score) AS avgScore FROM recits");
        $recit_data = $stmt_recitations->fetch(PDO::FETCH_ASSOC);
        $dashboard_stats['totalRecitations'] = $recit_data['totalRecitations'] ?? 0;
        $dashboard_stats['avgScore'] = $recit_data['avgScore'] ?? 0;

        $stmt_classes = $conn->query("SELECT COUNT(class_id) AS totalClasses FROM class_sections");
        $dashboard_stats['totalClasses'] = $stmt_classes->fetchColumn();
        
        $stmt_engaged = $conn->query("SELECT COUNT(DISTINCT student_id) AS engagedStudents FROM recits");
        $engagedStudents = $stmt_engaged->fetchColumn();
        $chart_engaged = $engagedStudents;
        $dashboard_stats['engagementRate'] = ($dashboard_stats['totalStudents'] > 0) ? round(($engagedStudents / $dashboard_stats['totalStudents']) * 100) : 0;

        // 2. Data for Bar Chart (Recitations per Subject)
        $stmt_chart = $conn->query("SELECT subject_code, COUNT(recit_id) as count FROM recits GROUP BY subject_code");
        $subject_stats = $stmt_chart->fetchAll(PDO::FETCH_ASSOC);
        
        $labels = [];
        $data = [];
        foreach ($subject_stats as $stat) {
            $labels[] = $stat['subject_code'];
            $data[] = $stat['count'];
        }
        $chart_labels_json = json_encode($labels);
        $chart_data_json = json_encode($data);
    }
    
} catch (PDOException $e) {
    $dashboard_stats['error'] = "Failed to load dashboard stats. (DB Error: " . $e->getMessage() . ")";
}

$allClasses = $manager->fetchAllClasses();
$classes = $allClasses;
if (empty($classes)) {
    $add_student_errors['general_classes'] = "Warning: No classes/subjects found. Please add subjects and class sections.";
}

$students_for_enrollment = $manager->viewStudents('lastName', 'ASC', 'all', '');
$allSubjects = $manager->fetchAllSubjects();
$allCourses = $manager->fetchAllCourses();

// --- Data Fetching for Reports Page ---
if ($current_section === 'reports') {
    if (!empty($report_class_name)) {
        // Generate Class Report
        $report_students = $manager->viewStudents('lastName', 'ASC', $report_class_name, '');
        foreach ($allClasses as $class) {
            if ($class['class_name'] === $report_class_name) {
                $report_class_details = $class;
                break;
            }
        }
    } elseif (!empty($report_student_id)) {
        // Generate Individual Student Report
        $report_student_details = $manager->fetchStudent($report_student_id);
        if ($report_student_details) {
            $report_student_subjects = $manager->getStudentEnrolledSubjects($report_student_id);
            // Loop and attach recitation data to each subject
            foreach ($report_student_subjects as $key => $subject) {
                $recits = $manager->getStudentRecitations($report_student_id, $subject['subject_code']);
                $avg = $manager->getStudentAverageScore($report_student_id, $subject['subject_code']);
                $report_student_subjects[$key]['recitations'] = $recits;
                $report_student_subjects[$key]['averageScore'] = $avg;
            }
        }
    }
}


if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST['form_action']) && $_POST['form_action'] === 'enroll_student') {
    $enroll_errors = [];
    $studentIdToEnroll = trim(htmlspecialchars($_POST["studentIdToEnroll"] ?? ""));
    $classIdToEnroll = trim(htmlspecialchars($_POST["classIdToEnroll"] ?? ""));
    if (empty($studentIdToEnroll)) { $enroll_errors["studentIdToEnroll"] = "Student ID is required."; }
    if (empty($classIdToEnroll)) { $enroll_errors["classIdToEnroll"] = "Class/Subject selection is required."; }

    if (empty(array_filter($enroll_errors))) {
        try {
            $conn = $manager->connect();
            $stmtCheckStudent = $conn->prepare("SELECT student_id FROM students WHERE student_id = ?");
            $stmtCheckStudent->execute([$studentIdToEnroll]);
            
            if ($stmtCheckStudent->rowCount() === 0) {
                 $enroll_errors["general"] = "Error: Student ID not found in the database.";
            } else {
                $stmtCheckEnroll = $conn->prepare("SELECT * FROM student_enrollments WHERE student_id = ? AND class_id = ?");
                $stmtCheckEnroll->execute([$studentIdToEnroll, $classIdToEnroll]);
                
                if ($stmtCheckEnroll->rowCount() > 0) {
                    $enroll_errors["general"] = "Student is already enrolled in this class/subject.";
                } else {
                    $insert_sql = "INSERT INTO student_enrollments (student_id, class_id) VALUES (:studentId, :classId)";
                    $insert_stmt = $conn->prepare($insert_sql);
                    $insert_stmt->bindParam(':studentId', $studentIdToEnroll);
                    $insert_stmt->bindParam(':classId', $classIdToEnroll);
                    
                    if ($insert_stmt->execute()) {
                        
                        // --- Send email and bell notification to the student ---
                        $manager->sendEnrollmentNotification($studentIdToEnroll, $classIdToEnroll);

                        header("Location: " . $_SERVER['PHP_SELF'] . "?section=view_students&enroll_success=true" . ($selected_class_filter !== 'all' ? '&class_filter=' . urlencode($selected_class_filter) : ''));
                        exit;
                    } else {
                        $enroll_errors["general"] = "Failed to enroll student due to a database error.";
                    }
                }
            }
        } catch (PDOException $e) {
             $enroll_errors["general"] = "Database error during enrollment: " . $e->getMessage();
        }
    }
    $add_student_errors = array_merge($add_student_errors, $enroll_errors);
}

if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST['form_action']) && $_POST['form_action'] === 'record_recitation') {
    $studentId = $_POST['studentId'] ?? null;
    $subjectCode = $_POST['subjectCode'] ?? null;
    $score = $_POST['score'] ?? null;
    $date = $_POST['date'] ?? date('Y-m-d');
    $mode = $_POST['mode'] ?? null;
    if (empty($studentId) || !$manager->fetchStudent($studentId)) { $score_errors['general'] = "Invalid student ID."; }
    elseif (empty($subjectCode)) { $score_errors['general'] = "Invalid subject code."; }
    elseif (!is_numeric($score) || $score < 0 || $score > $maxScore) { $score_errors['score'] = "Score must be between 0 and " . $maxScore . "."; }
    elseif (strtolower($mode) !== 'normal' && strtolower($mode) !== 'fair') { $score_errors['mode'] = "Invalid mode selected."; }
    if (empty($score_errors)) {
        $manager->recitationStudentId = $studentId;
        $manager->recitationSubjectCode = $subjectCode;
        $manager->recitationDate = $date;
        $manager->recitationScore = (float)$score;
        $manager->recitationMode = strtolower($mode);
        if ($manager->addRecitation()) {
            $score_success = true;
            $redirect_url = $_SERVER['PHP_SELF'] . "?section=view_students&rec_success=true";
            if ($selected_class_filter !== 'all') { $redirect_url .= "&class_filter=" . urlencode($selected_class_filter); }
            if (!empty($search_query)) { $redirect_url .= "&search_query=" . urlencode($search_query); }
            header("Location: " . $redirect_url);
            exit;
        } else {
            $score_errors['general'] = "Failed to save recitation due to a database error.";
        }
    }
}

if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST['form_action']) && $_POST['form_action'] === 'confirm_delete_student') {
    $studentIdToDelete = $_POST['studentIdToDeleteConfirmed'] ?? null;
    if ($studentIdToDelete) {
        if ($manager->deleteStudent($studentIdToDelete)) {
            header("Location: " . $_SERVER['PHP_SELF'] . "?section=delete_student&delete_success=true");
            exit;
        } else {
            $add_student_errors['general_delete'] = "Failed to delete student. (Database error or student not found)";
        }
    } else {
        $add_student_errors['general_delete'] = "No student ID provided for deletion.";
    }
}

// --- WITHDRAW STUDENT ---
if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST['form_action']) && $_POST['form_action'] === 'withdraw_student') {
    $studentIdToWithdraw = $_POST['student_id_to_withdraw'] ?? null;
    $classIdToWithdraw = $_POST['class_id_to_withdraw'] ?? null;
    $withdraw_reason = trim(htmlspecialchars($_POST['withdraw_reason'] ?? 'No reason provided'));

    if ($studentIdToWithdraw && $classIdToWithdraw) {
        // Pass the $withdraw_reason to the manager function
        if ($manager->withdrawStudentFromClass($studentIdToWithdraw, $classIdToWithdraw, $withdraw_reason)) {
            $redirect_url = $_SERVER['PHP_SELF'] . "?section=view_students&withdraw_success=true";
            if ($selected_class_filter !== 'all') { $redirect_url .= "&class_filter=" . urlencode($selected_class_filter); }
            if (!empty($search_query)) { $redirect_url .= "&search_query=" . urlencode($search_query); }
            header("Location: " . $redirect_url);
            exit;
        } else {
            $add_student_errors['general'] = "Failed to withdraw student from class.";
        }
    } else {
        $add_student_errors['general'] = "Invalid student or class ID for withdrawal.";
    }
}

if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST['form_action']) && $_POST['form_action'] === 'add_class') {
    $class_name = trim(htmlspecialchars($_POST['class_name'] ?? ''));
    $subject_code = trim(htmlspecialchars($_POST['subject_code'] ?? ''));

    if (empty($class_name) || empty($subject_code)) {
        $add_student_errors['general_add_class'] = "Both Class Name and Subject are required.";
    } else {
        if ($manager->addClassSection($class_name, $subject_code)) {
            header("Location: " . $_SERVER['PHP_SELF'] . "?section=manage_classes&class_add_success=true");
            exit;
        } else {
            $add_student_errors['general_add_class'] = "Failed to add class. The class name might already exist.";
        }
    }
}

if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST['form_action']) && $_POST['form_action'] === 'confirm_delete_class') {
    $class_id_to_delete = $_POST['class_id_to_delete_confirmed'] ?? null;
    
    if ($class_id_to_delete) {
        if ($manager->deleteClassSection($class_id_to_delete)) {
            header("Location: " . $_SERVER['PHP_SELF'] . "?section=manage_classes&class_delete_success=true");
            exit;
        } else {
             $add_student_errors['general_delete_class'] = "Failed to delete class. Students might be enrolled in it.";
        }
    } else {
        $add_student_errors['general_delete_class'] = "No class section selected for deletion.";
    }
}

if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST['form_action']) && $_POST['form_action'] === 'add_subject') {
    $subject_code = trim(htmlspecialchars($_POST['subject_code'] ?? ''));
    $subject_name = trim(htmlspecialchars($_POST['subject_name'] ?? ''));
    
    if (empty($subject_code) || empty($subject_name)) {
        $add_student_errors['general_add_subject'] = "Both Subject Code and Subject Name are required.";
    } else {
        if ($manager->addSubject($subject_code, $subject_name)) {
            header("Location: " . $_SERVER['PHP_SELF'] . "?section=manage_classes&subject_add_success=true");
            exit;
        } else {
            $add_student_errors['general_add_subject'] = "Failed to add subject. The Subject Code might already exist.";
        }
    }
}

if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST['form_action']) && $_POST['form_action'] === 'confirm_delete_subject') {
    $subject_code_to_delete = $_POST['subject_code_to_delete_confirmed'] ?? null;
    
    if ($subject_code_to_delete) {
        if ($manager->deleteSubject($subject_code_to_delete)) {
            header("Location: " . $_SERVER['PHP_SELF'] . "?section=manage_classes&subject_delete_success=true");
            exit;
        } else {
             $add_student_errors['general_delete_subject'] = "Failed to delete subject. It might be linked to a class section.";
        }
    } else {
        $add_student_errors['general_delete_subject'] = "No subject selected for deletion.";
    }
}

if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST['form_action']) && $_POST['form_action'] === 'add_course') {
    $course_name = trim(htmlspecialchars($_POST['course_name'] ?? ''));
    
    if (empty($course_name)) {
        $add_student_errors['general_add_course'] = "Course Name is required.";
    } else {
        if ($manager->addCourse($course_name)) {
            header("Location: " . $_SERVER['PHP_SELF'] . "?section=manage_classes&course_add_success=true");
            exit;
        } else {
            $add_student_errors['general_add_course'] = "Failed to add course. The Course Name might already exist.";
        }
    }
}

if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST['form_action']) && $_POST['form_action'] === 'confirm_delete_course') {
    $course_id_to_delete = $_POST['course_id_to_delete_confirmed'] ?? null;
    
    if ($course_id_to_delete) {
        if ($manager->deleteCourse($course_id_to_delete)) {
            header("Location: " . $_SERVER['PHP_SELF'] . "?section=manage_classes&course_delete_success=true");
            exit;
        } else {
             $add_student_errors['general_delete_course'] = "Failed to delete course. Students might be enrolled in it.";
        }
    } else {
        $add_student_errors['general_delete_course'] = "No course selected for deletion.";
    }
}


$students = $manager->viewStudents($sort_column, $sort_order, $selected_class_filter, $search_query);
$students_json = json_encode(array_values($students));

if(isset($_GET['class_add_success']) || isset($_GET['class_delete_success'])) { $allClasses = $manager->fetchAllClasses(); $classes = $allClasses; }
if(isset($_GET['subject_add_success']) || isset($_GET['subject_delete_success'])) { $allSubjects = $manager->fetchAllSubjects(); }
if(isset($_GET['course_add_success']) || isset($_GET['course_delete_success'])) { $allCourses = $manager->fetchAllCourses(); }
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Digital Recitation</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; display: flex; min-height: 100vh; }
        .sidebar { width: 250px; background-color: #D32F2F; color: white; padding: 20px 0; display: flex; flex-direction: column; flex-shrink: 0; height: 100vh; position: sticky; top: 0; box-shadow: 2px 0 8px rgba(0,0,0,0.2); overflow-y: auto; }
        .sidebar-header { text-align: center; padding: 10px 15px; margin-bottom: 30px; }
        .sidebar-header img { width: 90px; height: 90px; border-radius: 50%; background-color: white; padding: 5px; object-fit: cover; border: 3px solid #FFCDD2; margin-bottom: 10px; }
        .sidebar-header h2 { color: #FFEBEE; margin: 0; font-size: 1.4em; font-weight: 600; }
        .sidebar-nav ul { list-style: none; padding: 0; margin: 0; }
        
        /* NAVBAR: Title Case (Not All Caps) */
        .sidebar-nav ul li a { display: flex; align-items: center; padding: 12px 20px; color: white; text-decoration: none; font-size: 1.05em; transition: background-color 0.3s, border-left 0.3s; text-transform: none; }
        
        .sidebar-nav ul li a .material-icons { margin-right: 15px; font-size: 24px; color: white; }
        .sidebar-nav ul li a:hover { background-color: #B71C1C; border-left: 5px solid #FFEBEE; padding-left: 15px; }
        .sidebar-nav ul li a.active { background-color: #B71C1C; border-left: 5px solid white; padding-left: 15px; font-weight: bold; }
        .sidebar-nav ul li a.delete-link:hover { background-color: #c62828; border-left-color: #FF8A80; }
        .main-wrapper { flex-grow: 1; display: flex; flex-direction: column; min-width: 0; }
        .top-navbar { background-color: #ffffff; padding: 15px 25px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-sizing: border-box; }
        .top-navbar h1 { margin: 0; color: #333; font-size: 1.9em; font-weight: 600; }
        .user-menu { display: flex; align-items: center; }
        .user-menu .material-icons { font-size: 28px; margin-right: 10px; color: #757575; }
        .user-menu span { font-weight: 600; color: #555; font-size: 1.1em; }
        .logout-btn { background-color: #D32F2F; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9em; font-weight: bold; margin-left: 15px; text-decoration: none; transition: background-color 0.3s ease; }
        .logout-btn:hover { background-color: #C62828; }
        .main-content { padding: 30px; flex-grow: 1; background-color: #f8f8f8; box-sizing: border-box; }
        .container { max-width: 1200px; margin: 0 auto; background-color: #ffffff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .form-container { background-color: #ffffff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 650px; width: 100%; box-sizing: border-box; margin: 20px auto; }
        .content-header h2, h1.section-title { margin: 0 0 25px 0; font-size: 1.8em; color: #333; border-bottom: 2px solid #D32F2F; padding-bottom: 10px; text-align: center; }
        
        /* Dashboard Stats */
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .card { background-color: #ffffff; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); padding: 25px; text-align: center; transition: transform 0.2s ease, box-shadow 0.2s ease; cursor: default; border-top: 5px solid #D32F2F; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
        .card .material-icons { font-size: 50px; color: #D32F2F; margin-bottom: 10px; }
        .card h3 { margin-top: 0; margin-bottom: 10px; font-size: 1.1em; color: #555;}
        .card .card-number { font-size: 2.3em; font-weight: bold; color: #333; margin-top: 5px; }
        
        /* Dashboard Charts */
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .chart-container { background-color: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .chart-container h3 { margin-top: 0; text-align: center; color: #333; font-size: 1.1em; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }

        table { width: 100%; border-collapse: collapse; margin-top: 25px; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #e0e0e0; padding: 12px 15px; text-align: left; font-size: 0.95em; vertical-align: middle;}
        th { background-color: #D32F2F; color: white; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }
        tr:nth-child(even) { background-color: #f8f9fa; }
        td { color: #333; }
        th a { color: white; text-decoration: none; }
        th a:hover { text-decoration: underline; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; font-size: 1em; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 1em; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: #D32F2F; outline: none; box-shadow: 0 0 0 2px rgba(211, 47, 47, 0.2); }
        .form-error { color: #D32F2F; font-size: 0.85em; margin-top: 5px; }
        .btn { padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; font-weight: bold; transition: background-color 0.3s ease; text-align: center; display: inline-block; text-decoration: none;}
        .btn-small { padding: 5px 10px; font-size: 0.85em; font-weight: normal; }
        .btn-submit { background-color: #D32F2F; color: white; }
        .btn-submit:hover { background-color: #C62828; }
        .btn-delete { background-color: #D32F2F; color: white; }
        .btn-delete:hover { background-color: #C62828; }
        .btn-picker { background-color: #D32F2F; color: white; margin: 0 10px 15px; }
        .btn-picker:hover { background-color: #C62828; }
        .btn-record { background-color: #D32F2F; color: white; margin-top: 15px; }
        .btn-record:hover { background-color: #C62828; }
        .btn-cancel { background-color: #6c757d; color: white; margin-left: 10px; }
        .btn-cancel:hover { background-color: #5a6268; }
        .btn-search { background-color: #D32F2F; color: white; padding: 10px 15px; font-size: 0.9em; }
        .btn-search:hover { background-color: #C62828; }
        .btn-withdraw { background-color: #f44336; color: white; }
        .btn-withdraw:hover { background-color: #d32f2f; }
        
        /* Updated Print Button (Red) */
        .btn-print { background-color: #D32F2F; color: white; padding: 10px 20px; }
        .btn-print:hover { background-color: #C62828; }
        
        button:disabled, .btn:disabled { background-color: #cccccc; cursor: not-allowed; opacity: 0.7; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 500px; position: relative; border-top: 5px solid #D32F2F; }
        .modal-content h2, .modal-content h3 { margin-top: 0; color: #D32F2F; text-align: center; margin-bottom: 20px;}
        .close-button, .modal-close-button { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 30px; font-weight: bold; cursor: pointer; line-height: 1; }
        .close-button:hover, .modal-close-button:hover { color: #333; }
        .modal-body { margin-bottom: 20px; text-align: center; line-height: 1.5; }
        .modal-body strong { color: #333; }
        .modal-footer { text-align: center; margin-top: 20px; }
        .modal-submit-button { width: 100%; margin-top: 20px;}
        .filter-control { margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; gap: 15px; flex-wrap: wrap;}
        .filter-control .filter-group { display: flex; align-items: center; gap: 10px; flex-wrap: wrap;}
        .filter-control label { font-weight: bold; color: #333; }
        .filter-control select { padding: 10px; border: 1px solid #ccc; border-radius: 4px; background-color: white; }
        .filter-control input[type="search"], .filter-control input[type="text"] { padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        #picker-toggle-button { background-color: #D32F2F; color: white; padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; font-weight: bold; display: block; width: fit-content; margin: 0 auto 25px auto; }
        #picker-toggle-button:hover { background-color: #C62828; }
        #randomizer-control { border: 2px solid #FFCDD2; padding: 25px; border-radius: 10px; text-align: center; margin-bottom: 30px; background-color: #FFEBEE; display: none; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        #randomizer-control h2 { margin-top: 0; color: #D32F2F; }
        #result-display { margin: 20px 0; font-size: 1.1em; min-height: 80px; display: flex; align-items: center; justify-content: center; flex-direction: column;}
        .info-text { font-size: 0.9em; color: #555; margin-top: 15px; }
        .error-message, .error-general { color: #B71C1C; font-weight: bold; background-color: #FFEBEE; padding: 12px; border-radius: 6px; text-align: center; margin-bottom: 20px; border: 1px solid #EF9A9A; }
        .success-message { color: #2E7D32; font-weight: bold; background-color: #E8F5E9; padding: 12px; border-radius: 6px; text-align: center; margin-bottom: 20px; border: 1px solid #A5D6A7; }
        .no-records { text-align: center; color: #757575; font-style: italic; padding: 20px; background-color: #fff; border-radius: 8px; margin-top: 20px; border: 1px dashed #ccc; }
        hr.form-separator { border: 0; height: 1px; background-color: #eee; margin: 30px 0; }
        .status-badge { display: inline-block; padding: 0.3em 0.6em; font-size: 0.8em; font-weight: bold; border-radius: 4px; line-height: 1; }
        .status-enrolled { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
        .status-not-enrolled { background-color: #fff3e0; color: #e65100; border: 1px solid #ffcc80; }
        
        /* --- MATCHING IMAGE DESIGN (MANAGE CLASSES) --- */
        .manage-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 25px; 
            align-items: stretch; /* Forces all cards to be equal height */
        }

        .manage-card {
            background-color: #ffffff;
            border-radius: 12px; /* Softer corners */
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: none;
            border-top: 5px solid #D32F2F; /* Red top border */
            display: flex;
            flex-direction: column;
            height: 100%; /* Fills the grid cell height */
            padding: 25px;
            box-sizing: border-box;
        }

        .manage-card h3 {
            margin: 0 0 20px 0;
            color: #444;
            font-size: 1.1em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        /* "ADD NEW" and "DELETE" labels */
        .section-label {
            color: #D32F2F; /* UPDATED: Dark Red */
            font-weight: 700;
            font-size: 0.85em;
            text-transform: uppercase;
            margin-bottom: 10px;
            display: block;
            letter-spacing: 0.5px;
        }

        .manage-top-section {
            margin-bottom: 20px;
        }

        .manage-bottom-section {
            margin-top: auto; /* THIS IS THE KEY: Pushes delete section to bottom */
            padding-top: 20px;
            border-top: 1px dashed #e0e0e0;
        }

        .manage-card .form-group {
            margin-bottom: 15px;
        }

        .manage-card input, .manage-card select {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 12px;
            font-size: 0.95em;
            color: #555;
        }

        .manage-card input:focus, .manage-card select:focus {
            background-color: #fff;
            border-color: #D32F2F; /* UPDATED: Dark Red */
        }

        /* Button Styling specific to this card */
        .btn-card-add {
            background-color: #D32F2F; /* UPDATED: Dark Red */
            color: white;
            width: 100%;
            border-radius: 6px;
            text-transform: uppercase;
            font-size: 0.9em;
            letter-spacing: 1px;
        }
        .btn-card-add:hover { background-color: #b71c1c; }

        .btn-card-delete {
            background-color: #D32F2F; /* UPDATED: Red */
            color: white;
            width: 100%;
            border-radius: 6px;
            text-transform: uppercase;
            font-size: 0.9em;
            letter-spacing: 1px;
        }
        .btn-card-delete:hover { background-color: #b71c1c; }
        /* --- END MATCHING IMAGE DESIGN --- */

        .report-header { text-align: center; margin-bottom: 30px; display: none; }
        .report-header img { width: 80px; height: auto; }
        .report-header h2 { margin: 10px 0 5px 0; color: #000; }
        .report-header p { margin: 0; font-size: 1em; color: #555; }
        .report-summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .report-summary-box { background-color: #f8f8f8; border: 1px solid #eee; border-left: 5px solid #D32F2F; padding: 15px; border-radius: 5px; }
        .report-summary-box h4 { margin: 0 0 10px 0; color: #D32F2F; }
        .report-summary-box p { margin: 0; font-size: 1.5em; font-weight: 600; color: #333; }
        .report-student-subject-header { background-color: #f1f1f1; padding: 10px; border-radius: 5px; margin-top: 20px; }
        .report-student-subject-header h4 { margin: 0; color: #333; }
        .report-student-subject-header p { margin: 5px 0 0 0; font-size: 0.9em; color: #555; }

        @media (max-width: 992px) {
             body { flex-direction: column; }
             .sidebar { width: 100%; height: auto; position: static; flex-direction: row; justify-content: space-around; padding: 5px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); order: 2; overflow-y: hidden; }
             .sidebar-header { display: none; }
             .sidebar-nav { width: 100%; }
             .sidebar-nav ul { display: flex; justify-content: space-around; flex-wrap: wrap; }
             .sidebar-nav ul li { margin-bottom: 0; flex-basis: auto; text-align: center; }
             .sidebar-nav ul li a { padding: 8px 5px; font-size: 0.8em; flex-direction: column; align-items: center; border-left: none !important; }
              .sidebar-nav ul li a:hover, .sidebar-nav ul li a.active { background-color: #B71C1C; padding-left: 5px; }
             .sidebar-nav ul li a .material-icons { margin-right: 0; margin-bottom: 3px; font-size: 20px; }
             .top-navbar { width: 100%; order: 1; }
             .main-content { width: 100%; padding: 20px; order: 3; }
             .top-navbar h1 { font-size: 1.5em; }
             .manage-grid { grid-template-columns: 1fr; }
             .grid-column .form-container { min-height: auto; }
             .chart-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .filter-control { flex-direction: column; align-items: stretch; }
            .filter-control .filter-group { justify-content: space-between; }
            .filter-control .search-group { width: 100%; margin-top: 10px; display: flex; }
            .filter-control input[type="search"] { flex-grow: 1; }
        }
        @media (max-width: 600px) {
             .top-navbar { flex-direction: column; gap: 10px; padding: 10px 15px; }
             .user-menu { margin-top: 10px; }
             .main-content { padding: 15px; }
             h1.section-title { font-size: 1.6em; }
             .card-grid { grid-template-columns: 1fr; }
             .form-container { padding: 20px; }
             .modal-content { padding: 20px; }
             th, td { padding: 8px 10px; font-size: 0.9em;}
             .modal-footer button, .modal-footer .btn { width: 100%; margin: 5px 0 !important; }
             .report-summary-grid { grid-template-columns: 1fr; }
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Updated Print Styling: Simple, Black/White, No Designs */
        @media print {
            body { 
                display: block; 
                background-color: #fff; 
                font-family: 'Times New Roman', Times, serif; 
                font-size: 12pt;
                color: #000;
            }
            .sidebar, .top-navbar, .filter-control, #picker-toggle-button, .modal, .form-container, .btn, .logout-btn, .sidebar-nav, .user-menu, .no-records-message, .btn-withdraw, th.action-header, td.action-cell, #report-selector-forms, #printReportButton { display: none !important; }
            .main-wrapper { flex-grow: 1; display: block; }
            .main-content { padding: 0; margin: 0; }
            .container { max-width: 100%; margin: 0; padding: 20px; box-shadow: none; border-radius: 0; border: none; }
            h1.section-title { margin: 0 0 20px 0; color: #000; text-align: center; border-bottom: 1px solid #000; }
            
            .report-header { display: block !important; text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 15px; }
            .report-header img { width: 80px; height: auto; }
            .report-header h2 { margin: 10px 0 5px 0; color: #000; }
            .report-header p { margin: 0; font-size: 1em; color: #000; }
            
            /* TRANSFORM THE SUMMARY BOXES INTO SIMPLE TEXT LINES */
            .report-summary-grid {
                display: block !important;
                margin-bottom: 15px;
                text-align: left;
                border: none;
            }
            .report-summary-box {
                display: inline-block;
                background: none !important;
                border: none !important;
                padding: 0;
                margin-right: 40px;
                box-shadow: none !important;
            }
            .report-summary-box h4 {
                display: inline;
                margin: 0;
                color: #000 !important;
                font-weight: normal;
                font-size: 1em;
            }
            .report-summary-box h4::after {
                content: ": ";
            }
            .report-summary-box p {
                display: inline;
                margin: 0;
                color: #000 !important;
                font-weight: bold;
                font-size: 1em !important;
            }

            /* COMPACT TABLE FOR PRINTING */
            table { margin-top: 10px; box-shadow: none; border-collapse: collapse; width: 100%; border: 1px solid #000; font-size: 10pt; }
            th { background-color: transparent !important; color: #000 !important; border: 1px solid #000; font-weight: bold; padding: 4px; }
            td { border: 1px solid #000; color: #000; padding: 4px; }
            tr:nth-child(even) { background-color: transparent !important; }
            
            .status-badge { border: none; background-color: transparent; color: #000; padding: 0; }
            .text-right { text-align: right; }
            .text-center { text-align: center; }
            a { text-decoration: none; color: #000; }
            h1, h2, h3, h4, p, span { color: #000 !important; }
            
            /* Hide dashboard elements if trying to print dashboard */
            .card-grid, .chart-grid { display: none; }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
             <img src="../images/logowmsu.jpg" alt="WMSU Logo">
             <h2>Digital Class Recitation</h2>
        </div>
        <nav class="sidebar-nav">
            <ul>
                <li><a href="?section=dashboard" class="<?= ($current_section == 'dashboard' ? 'active' : '') ?>"><span class="material-icons">dashboard</span>Dashboard</a></li>
                <li><a href="?section=view_students" class="<?= ($current_section == 'view_students' ? 'active' : '') ?>"><span class="material-icons">people</span>View Students</a></li>
                <li><a href="?section=add_student" class="<?= ($current_section == 'add_student' ? 'active' : '') ?>"><span class="material-icons">person_add</span>Enroll Student</a></li>
                <li><a href="?section=manage_classes" class="<?= ($current_section == 'manage_classes' ? 'active' : '') ?>"><span class="material-icons">class</span>Manage Classes</a></li>
                <li><a href="?section=recitation_records" class="<?= ($current_section == 'recitation_records' ? 'active' : '') ?>"><span class="material-icons">assignment</span>Recitation Records</a></li>
                <li><a href="?section=reports" class="<?= ($current_section == 'reports' ? 'active' : '') ?>"><span class="material-icons">print</span>Reports</a></li>
                <li><a href="?section=delete_student" class="delete-link <?= ($current_section == 'delete_student' ? 'active' : '') ?>"><span class="material-icons">person_remove</span>Delete Student</a></li>
            </ul>
        </nav>
    </div>

    <div class="main-wrapper">
         <nav class="top-navbar">
            <h1><?= ucfirst(str_replace('_', ' ', $current_section)) ?></h1>
            <div class="user-menu">
                <span class="material-icons">account_circle</span>
                <span>Professor</span>
                 <a href="logout.php" class="logout-btn">Logout</a>
            </div>
        </nav>

        <main class="main-content">
             <?php if ($current_section === 'dashboard'): ?>
                <div class="container">
                    <h1 class="section-title">System Overview</h1>
                    <?php if (isset($dashboard_stats['error'])): ?><p class="error-message"><?= $dashboard_stats['error'] ?></p><?php endif; ?>
                    
                    <div class="card-grid">
                        <div class="card"><span class="material-icons">group</span><h3>Total Students</h3><p class="card-number"><?= htmlspecialchars($dashboard_stats['totalStudents'] ?? 'N/A') ?></p></div>
                        <div class="card"><span class="material-icons">assessment</span><h3>Total Recitations</h3><p class="card-number"><?= htmlspecialchars($dashboard_stats['totalRecitations'] ?? 'N/A') ?></p></div>
                        <div class="card"><span class="material-icons">class</span><h3>Active Classes</h3><p class="card-number"><?= htmlspecialchars($dashboard_stats['totalClasses'] ?? 'N/A') ?></p></div>
                        <div class="card"><span class="material-icons">bar_chart</span><h3>Overall Avg. Score</h3><p class="card-number"><?= number_format($dashboard_stats['avgScore'] ?? 0, 2) ?> / <?= $maxScore ?></p></div>
                        <div class="card"><span class="material-icons">pie_chart</span><h3>Engagement Rate</h3><p class="card-number"><?= htmlspecialchars($dashboard_stats['engagementRate'] ?? 0) ?>%</p></div>
                    </div>

                    <div class="chart-grid">
                        <div class="chart-container">
                            <h3>Engagement Breakdown</h3>
                            <canvas id="engagementChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>Recitations by Subject</h3>
                            <canvas id="subjectChart"></canvas>
                        </div>
                    </div>
                </div>

            <?php elseif ($current_section === 'recitation_records'): ?>
                <div class="container">
                    <h1 class="section-title">All Recitation Records</h1>
                    
                    <div class="filter-control">
                        <form method="GET" action="" style="width: 100%; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                            <input type="hidden" name="section" value="recitation_records">
                            <div class="filter-group">
                                <label for="rec_class_filter">Filter by Class:</label>
                                <select name="class_filter" id="rec_class_filter" onchange="this.form.submit()">
                                    <option value="all">All Classes/Subjects</option>
                                    <?php
                                    $rec_selected_class_filter = $_GET['class_filter'] ?? 'all';
                                    $unique_classes_recs = [];
                                    foreach ($allClasses as $class) { $unique_classes_recs[$class['class_name']] = $class['subject_name_display'] . ' (' . $class['class_name'] . ')'; }
                                    foreach ($unique_classes_recs as $className => $subjectDisplay): ?>
                                        <option value="<?= htmlspecialchars($className) ?>" <?= ($rec_selected_class_filter === $className) ? 'selected' : '' ?>><?= htmlspecialchars($subjectDisplay) ?></option>
                                    <?php endforeach; ?>
                                </select>
                            </div>
                            <div class="search-group" style="display: flex; gap: 5px;">
                                <input type="search" name="search_query" value="<?= htmlspecialchars($search_query) ?>" placeholder="Search ID or Name...">
                                <button type="submit" class="btn btn-search"><span class="material-icons">search</span></button>
                            </div>
                        </form>
                    </div>

                    <?php
                    try {
                        $conn = $manager->connect();
                        $sql = "SELECT r.date, r.score, r.mode, s.student_id, s.firstname, s.lastname, cs.class_name, sub.subject_name 
                                FROM recits r 
                                JOIN students s ON r.student_id = s.student_id 
                                LEFT JOIN student_enrollments se ON s.student_id = se.student_id
                                LEFT JOIN class_sections cs ON se.class_id = cs.class_id
                                LEFT JOIN subjects sub ON r.subject_code = sub.subject_code";
                        $where = [];
                        $params = [];

                        if ($rec_selected_class_filter !== 'all') {
                            $where[] = "cs.class_name = :className";
                            $params[':className'] = $rec_selected_class_filter;
                        }
                        
                        if (!empty($search_query)) {
                            $where[] = "(s.student_id LIKE :search OR s.firstname LIKE :search OR s.lastname LIKE :search OR CONCAT(s.firstname, ' ', s.lastname) LIKE :search)";
                            $params[':search'] = "%" . $search_query . "%";
                        }
                        
                        if (!empty($where)) { $sql .= " WHERE " . implode(' AND ', $where); }
                         $sql .= " GROUP BY r.recit_id";
                        $sql .= " ORDER BY r.date DESC, s.lastname ASC";
                        
                        $stmt = $conn->prepare($sql);
                        $stmt->execute($params);
                        $allRecs = $stmt->fetchAll(PDO::FETCH_ASSOC);
                    } catch (PDOException $e) { $allRecs = []; echo '<p class="error-message">Failed to fetch data: ' . $e->getMessage() . '</p>'; }
                    ?>
                    
                    <?php if (!empty($allRecs)): ?>
                        <table><thead><tr><th>Date</th><th>ID</th><th>Name</th><th>Class</th><th>Subject</th><th class="text-center">Score</th><th>Mode</th></tr></thead><tbody><?php foreach ($allRecs as $rec): ?><tr><td><?= htmlspecialchars(date('M d, Y h:i A', strtotime($rec['date']))) ?></td><td><?= htmlspecialchars($rec['student_id']) ?></td><td><?= htmlspecialchars($rec['lastname'] . ', ' . $rec['firstname']) ?></td><td><?= htmlspecialchars($rec['class_name'] ?? 'N/A') ?></td><td><?= htmlspecialchars($rec['subject_name'] ?? $rec['subject_code'] ?? 'N/A') ?></td><td class="text-center"><?= htmlspecialchars($rec['score']) ?> / <?= $maxScore ?></td><td><?= htmlspecialchars(ucfirst($rec['mode'])) ?></td></tr><?php endforeach; ?></tbody></table>
                    <?php else: ?>
                        <p class="no-records">No recitation records found<?= (!empty($search_query) ? ' for "' . htmlspecialchars($search_query) . '"' : '') ?><?= ($rec_selected_class_filter !== 'all' ? ' in the selected class.' : '.') ?></p>
                    <?php endif; ?>
                </div>
            <?php elseif ($current_section === 'view_students'): ?>
                <div class="container">
                    <h1 class="section-title">View Students</h1>
                    <?php if (isset($_GET['rec_success'])): ?><p class="success-message">Recitation score recorded!</p><?php endif; ?>
                    <?php if (isset($_GET['enroll_success'])): ?><p class="success-message">Student enrolled!</p><?php endif; ?>
                    <?php if (isset($_GET['withdraw_success'])): ?><p class="success-message">Student withdrawn from class!</p><?php endif; ?>
                    <?php if (!empty($score_errors)): ?><p class="error-message">Score Submission Failed: <?= implode(" ", $score_errors) ?></p><?php endif; ?>
                    <?php if (isset($add_student_errors["general"])): ?><p class="error-message"><?= htmlspecialchars($add_student_errors["general"]) ?></p><?php endif; ?>
                    
                    <div class="filter-control">
                        <form method="GET" action="" style="width: 100%; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                            <input type="hidden" name="section" value="view_students">
                            <div class="filter-group">
                                <label for="class_filter">Filter by Class:</label>
                                <select name="class_filter" id="class_filter" onchange="this.form.submit()">
                                    <option value="all">All Classes/Subjects</option>
                                    <?php $unique_classes_view = []; foreach ($allClasses as $class) { $unique_classes_view[$class['class_name']] = $class['subject_name_display'] . ' (' . $class['class_name'] . ')'; } foreach ($unique_classes_view as $className => $subjectDisplay): ?>
                                    <option value="<?= htmlspecialchars($className) ?>" <?= ($selected_class_filter === $className) ? 'selected' : '' ?>><?= htmlspecialchars($subjectDisplay) ?></option>
                                    <?php endforeach; ?>
                                </select>
                            </div>
                            <div class="search-group" style="display: flex; gap: 5px;">
                                <input type="search" name="search_query" value="<?= htmlspecialchars($search_query) ?>" placeholder="Search ID or Name...">
                                <button type="submit" class="btn btn-search"><span class="material-icons">search</span></button>
                            </div>
                        </form>
                    </div>

                    <?php if ($selected_class_filter !== 'all'): ?>
                        <button id="picker-toggle-button"><span class="material-icons" style="vertical-align: middle; margin-right: 5px;">touch_app</span>Pick a Student for Recitation</button>
                        <div id="randomizer-control">
                            <h2>Student Recitation Picker</h2>
                            <button id="btn-fair" class="btn btn-picker" data-mode="Fair"><span class="material-icons" style="vertical-align: middle; font-size: 1.2em;">balance</span> Fair Mode</button>
                            <button id="btn-normal" class="btn btn-picker" data-mode="Normal"><span class="material-icons" style="vertical-align: middle; font-size: 1.2em;">shuffle</span> Normal Mode</button>
                            <div id="result-display">Click a button to pick a student.</div>
                            <p class="info-text"><strong>Fair Mode:</strong> Prioritizes 0 recitations.<br><strong>Normal Mode:</strong> Picks randomly from filtered, enrolled students who haven't reached max recitations.</p>
                        </div>
                    <?php else: ?>
                        <p class="no-records-message" style="background-color: #e3f2fd; color: #0d47a1; border: 1px solid #90caf9;">Please select a specific Class/Subject from the filter above to use the Student Picker.</p>
                    <?php endif; ?>

                    <hr class="form-separator">
                    <?php if (empty($students)): ?>
                        <p class="no-records">No students found<?= (!empty($search_query) ? ' for "' . htmlspecialchars($search_query) . '"' : '') ?><?= ($selected_class_filter !== 'all' ? ' in the selected class.' : '.') ?></p>
                    <?php else: ?>
                        <table><thead><tr><th>#</th><th>ID</th><th><a href="?section=view_students&sort=<?= ($sort_order == 'asc' ? 'desc' : 'asc') ?>&sort_col=lastName&class_filter=<?= htmlspecialchars($selected_class_filter) ?>">Last Name <?= ($sort_column == 'lastName' ? ($sort_order == 'asc' ? '&#9660;' : '&#9650;') : '') ?></a></th><th>First Name</th><th>M.I.</th>
                        <?php if ($selected_class_filter === 'all'): ?>
                            <th class="text-center">Subjects Enrolled</th>
                        <?php else: ?>
                            <th>Class</th>
                        <?php endif; ?>
                        <th>Status</th><th class="text-center">Recits</th><th class="text-right">Avg Score</th>
                        <?php if ($selected_class_filter !== 'all'): ?>
                            <th class="text-center action-header">Action</th>
                        <?php endif; ?>
                        </tr></thead>
                        <tbody><?php $no = 1; foreach ($students as $student): ?>
                            <tr>
                                <td><?= $no++ ?></td><td><?= htmlspecialchars($student["student_id"]) ?></td>
                                <td><?= htmlspecialchars($student["lastname"]) ?></td><td><?= htmlspecialchars($student["firstname"]) ?></td>
                                <td><?= htmlspecialchars(substr($student["middlename"] ?? '', 0, 1)) ?></td>
                                
                                <?php if ($selected_class_filter === 'all'): ?>
                                    <td class="text-center"><?= htmlspecialchars($student["total_subjects_enrolled"]) ?></td>
                                    <td><?php if($student["total_subjects_enrolled"] > 0): ?><span class="status-badge status-enrolled">Enrolled</span><?php else: ?><span class="status-badge status-not-enrolled">Not Enrolled</span><?php endif; ?></td>
                                <?php else: ?>
                                    <td><?= htmlspecialchars($student["class_name"] ?? '-') ?></td>
                                    <td><span class="status-badge status-enrolled">Enrolled</span></td>
                                <?php endif; ?>

                                <td class="text-center"><?= htmlspecialchars($student["totalRecitations"]) ?></td>
                                <td class="text-right"><?= number_format($student["averageScore"], 2) ?></td>
                                
                                <?php if ($selected_class_filter !== 'all'): ?>
                                <td class="text-center action-cell">
                                    <button type="button" class="btn btn-small btn-withdraw" 
                                            data-studentid="<?= htmlspecialchars($student['student_id']) ?>" 
                                            data-classid="<?= htmlspecialchars($student['class_id']) ?>" 
                                            data-studentname="<?= htmlspecialchars($student['lastname'] . ', ' . $student['firstname']) ?>"
                                            data-classname="<?= htmlspecialchars($student['class_name']) ?>"
                                            title="Withdraw student from this class">
                                            <span class="material-icons" style="font-size: 1.2em; vertical-align: middle;">person_remove</span>
                                    </button>
                                </td>
                                <?php endif; ?>
                            </tr>
                        <?php endforeach; ?></tbody>
                        </table>
                    <?php endif; ?>
                    <div id="scoreModal" class="modal"><div class="modal-content"><span class="close-button">&times;</span><h2>Record Recitation Score</h2><p><strong>Student:</strong> <span id="modal-student-name"></span></p><p><strong>ID:</strong> <span id="modal-student-id-display"></span></p><p><strong>Mode:</strong> <span id="modal-mode"></span></p><form action="" method="post" id="scoreForm"><input type="hidden" name="form_action" value="record_recitation"><input type="hidden" name="studentId" id="modal-student-id"><input type="hidden" name="mode" id="modal-mode-input"><input type="hidden" name="subjectCode" id="modal-subject-code-input"><div class="form-group"><label for="modal-date">Date</label><input type="date" name="date" id="modal-date" value="<?= date('Y-m-d') ?>" required></div><div class="form-group"><label for="modal-score">Score (0 - <?= $maxScore ?>)</label><input type="number" name="score" id="modal-score" min="0" max="<?= $maxScore ?>" step="0.5" required></div><button type="submit" class="btn btn-submit modal-submit-button">Save Score</button></form></div></div>
                </div>
            <?php elseif ($current_section === 'add_student'): ?>
                <div class="form-container"><h1 class="section-title">Enroll Student</h1><p class="no-records-message" style="background-color:#FFEBEE; color:#D32F2F; border: 1px solid #FFCDD2;">Assign a registered student to a specific class section and subject.</p><hr class="form-separator"><?php if (isset($add_student_errors["general"])): ?><p class="error-message"><?= htmlspecialchars($add_student_errors["general"]) ?></p><?php endif; ?><?php if (isset($add_student_errors['general_classes'])): ?><p class="error-message"><?= htmlspecialchars($add_student_errors['general_classes']) ?></p><?php endif; ?><form action="" method="post"><input type="hidden" name="form_action" value="enroll_student">
                    <div class="form-group">
                        <label for="studentSearchInput">Search Student (by Name or ID)</label>
                        <input type="text" id="studentSearchInput" list="studentDatalist" placeholder="Type to search..." autocomplete="off" required>
                        <datalist id="studentDatalist">
                            <?php foreach ($students_for_enrollment as $student): ?>
                                <option value="<?= htmlspecialchars($student["lastname"] . ', ' . $student["firstname"] . ' (' . $student["student_id"] . ')') ?>" data-value="<?= htmlspecialchars($student["student_id"]) ?>">
                                    (Enrolled: <?= $student['total_subjects_enrolled'] ?>)
                                </option>
                            <?php endforeach; ?>
                        </datalist>
                        <input type="hidden" name="studentIdToEnroll" id="studentIdToEnroll">
                        <p class="form-error"><?= $add_student_errors["studentIdToEnroll"] ?? "" ?></p>
                    </div>
                    <div class="form-group"><label for="classIdToEnroll">Enroll into Class/Subject</label><select name="classIdToEnroll" id="classIdToEnroll" <?= empty($classes) ? 'disabled' : '' ?> required><option value="">-- Select Class/Subject --</option><?php foreach ($classes as $class): ?><option value="<?= $class["class_id"] ?>" <?= (isset($student_form_data["classIdToEnroll"]) && $student_form_data["classIdToEnroll"] == $class["class_id"]) ? 'selected' : '' ?>><?= htmlspecialchars($class["subject_name_display"] . ' (' . $class["class_name"] . ')') ?></option><?php endforeach; ?></select><p class="form-error"><?= $add_student_errors["classIdToEnroll"] ?? "" ?></p></div><button type="submit" class="btn btn-submit" <?= empty($classes) ? 'disabled' : '' ?>>Enroll Student</button></form></div>
            
            <?php elseif ($current_section === 'manage_classes'): ?>
                <div class="container">
                    <h1 class="section-title">Manage Academic Structure</h1>
                    
                    <?php if (isset($_GET['class_add_success'])): ?><p class="success-message">Class Section added successfully!</p><?php endif; ?>
                    <?php if (isset($_GET['class_delete_success'])): ?><p class="success-message">Class Section deleted successfully.</p><?php endif; ?>
                    <?php if (isset($_GET['subject_add_success'])): ?><p class="success-message">Subject added successfully!</p><?php endif; ?>
                    <?php if (isset($_GET['subject_delete_success'])): ?><p class="success-message">Subject deleted successfully.</p><?php endif; ?>
                    <?php if (isset($_GET['course_add_success'])): ?><p class="success-message">Course added successfully!</p><?php endif; ?>
                    <?php if (isset($_GET['course_delete_success'])): ?><p class="success-message">Course deleted successfully.</p><?php endif; ?>

                    <div class="manage-grid">
                        
                        <div class="manage-card">
                            <h3>Courses</h3>
                            
                            <div class="manage-top-section">
                                <span class="section-label">Add New</span>
                                <?php if (isset($add_student_errors["general_add_course"])): ?><p class="error-message"><?= htmlspecialchars($add_student_errors["general_add_course"]) ?></p><?php endif; ?>
                                <form action="" method="post">
                                    <input type="hidden" name="form_action" value="add_course">
                                    <div class="form-group">
                                        <input type="text" name="course_name" id="course_name" placeholder="Course Name (e.g. BSCS)" required>
                                    </div>
                                    <button type="submit" class="btn btn-card-add">Add</button>
                                </form>
                            </div>

                            <div class="manage-bottom-section">
                                <span class="section-label">Delete</span>
                                <?php if (isset($add_student_errors["general_delete_course"])): ?><p class="error-message"><?= htmlspecialchars($add_student_errors["general_delete_course"]) ?></p><?php endif; ?>
                                <form action="" method="post" id="deleteCourseInitialForm">
                                    <div class="form-group">
                                        <select id="courseIdToDelete" name="courseIdToDelete" required>
                                            <option value="">Select Course</option>
                                            <?php foreach ($allCourses as $course): ?>
                                                <option value="<?= htmlspecialchars($course["course_id"]) ?>" data-name="<?= htmlspecialchars($course["course_name"]) ?>">
                                                    <?= htmlspecialchars($course["course_name"]) ?>
                                                </option>
                                            <?php endforeach; ?>
                                        </select>
                                    </div>
                                    <button type="button" id="initiateDeleteCourseButton" class="btn btn-card-delete">Delete</button>
                                </form>
                            </div>
                        </div>

                        <div class="manage-card">
                            <h3>Subjects</h3>
                            
                            <div class="manage-top-section">
                                <span class="section-label">Add New</span>
                                <?php if (isset($add_student_errors["general_add_subject"])): ?><p class="error-message"><?= htmlspecialchars($add_student_errors["general_add_subject"]) ?></p><?php endif; ?>
                                <form action="" method="post">
                                    <input type="hidden" name="form_action" value="add_subject">
                                    <div class="form-group">
                                        <input type="text" name="subject_code" id="subject_code" placeholder="Code (e.g. CS101)" required>
                                    </div>
                                    <div class="form-group">
                                        <input type="text" name="subject_name" id="subject_name" placeholder="Name (e.g. Programming)" required>
                                    </div>
                                    <button type="submit" class="btn btn-card-add">Add</button>
                                </form>
                            </div>

                            <div class="manage-bottom-section">
                                <span class="section-label">Delete</span>
                                <?php if (isset($add_student_errors["general_delete_subject"])): ?><p class="error-message"><?= htmlspecialchars($add_student_errors["general_delete_subject"]) ?></p><?php endif; ?>
                                <form action="" method="post" id="deleteSubjectInitialForm">
                                    <div class="form-group">
                                        <select id="subjectCodeToDelete" name="subjectCodeToDelete" required>
                                            <option value="">Select Subject</option>
                                            <?php foreach ($allSubjects as $subject): ?>
                                                <option value="<?= htmlspecialchars($subject["subject_code"]) ?>" data-name="<?= htmlspecialchars($subject["subject_name"]) ?>">
                                                    <?= htmlspecialchars($subject['subject_name'] . ' (' . $subject['subject_code'] . ')') ?>
                                                </option>
                                            <?php endforeach; ?>
                                        </select>
                                    </div>
                                    <button type="button" id="initiateDeleteSubjectButton" class="btn btn-card-delete">Delete</button>
                                </form>
                            </div>
                        </div>

                        <div class="manage-card">
                            <h3>Class Sections</h3>
                            
                            <div class="manage-top-section">
                                <span class="section-label">Add New</span>
                                <?php if (isset($add_student_errors["general_add_class"])): ?><p class="error-message"><?= htmlspecialchars($add_student_errors["general_add_class"]) ?></p><?php endif; ?>
                                <form action="" method="post">
                                    <input type="hidden" name="form_action" value="add_class">
                                    <div class="form-group">
                                        <input type="text" name="class_name" id="class_name" placeholder="Name (e.g. BSCS-3A)" required>
                                    </div>
                                    <div class="form-group">
                                        <select name="subject_code" id="subject_code_class" required>
                                            <option value="">Select Subject</option>
                                            <?php foreach ($allSubjects as $subject): ?>
                                                <option value="<?= htmlspecialchars($subject['subject_code']) ?>">
                                                    <?= htmlspecialchars($subject['subject_name'] . ' (' . $subject['subject_code'] . ')') ?>
                                                </option>
                                            <?php endforeach; ?>
                                        </select>
                                    </div>
                                    <button type="submit" class="btn btn-card-add">Add</button>
                                </form>
                            </div>

                            <div class="manage-bottom-section">
                                <span class="section-label">Delete</span>
                                <?php if (isset($add_student_errors["general_delete_class"])): ?><p class="error-message"><?= htmlspecialchars($add_student_errors["general_delete_class"]) ?></p><?php endif; ?>
                                <form action="" method="post" id="deleteClassInitialForm">
                                    <div class="form-group">
                                        <select id="classIdToDelete" name="classIdToDelete" required>
                                            <option value="">Select Class</option>
                                            <?php foreach ($allClasses as $class): ?>
                                                <option value="<?= htmlspecialchars($class["class_id"]) ?>" data-name="<?= htmlspecialchars($class["subject_name_display"] . ' (' . $class["class_name"] . ')') ?>">
                                                    <?= htmlspecialchars($class["subject_name_display"] . ' (' . $class["class_name"] . ')') ?>
                                                </option>
                                            <?php endforeach; ?>
                                        </select>
                                    </div>
                                    <button type="button" id="initiateDeleteClassButton" class="btn btn-card-delete">Delete</button>
                                </form>
                            </div>
                        </div>

                    </div>
                </div>
            
            <?php elseif ($current_section === 'reports'): ?>
                <div class="container">
                    <div id="report-selector-forms">
                        <h1 class="section-title">Reports</h1>
                        <div class="form-container" style="max-width: 900px; margin-bottom: 30px;">
                            <div class="manage-grid" style="grid-template-columns: 1fr 1fr; gap: 40px;">
                                <div class="grid-column">
                                    <h3>Generate Class Report</h3>
                                    <form method="GET" action="">
                                        <input type="hidden" name="section" value="reports">
                                        <div class="form-group">
                                            <label for="report_class_name">Select Class:</label>
                                            <select name="report_class_name" id="report_class_name" required>
                                                <option value="">-- Select a Class --</option>
                                                <?php foreach ($allClasses as $class): ?>
                                                    <option value="<?= htmlspecialchars($class["class_name"]) ?>" <?= ($report_class_name === $class["class_name"]) ? 'selected' : '' ?>>
                                                        <?= htmlspecialchars($class["subject_name_display"] . ' (' . $class["class_name"] . ')') ?>
                                                    </option>
                                                <?php endforeach; ?>
                                            </select>
                                        </div>
                                        <button type="submit" class="btn btn-submit" style="width: 100%;">Generate Class Report</button>
                                    </form>
                                </div>
                                
                                <div class="grid-column">
                                    <h3>Generate Student Report</h3>
                                    <form method="GET" action="">
                                        <input type="hidden" name="section" value="reports">
                                        <div class="form-group">
                                            <label for="studentReportSearch">Search Student (by Name or ID)</label>
                                            <input type="text" id="studentReportSearch" list="studentReportDatalist" placeholder="Type to search..." autocomplete="off" required>
                                            <datalist id="studentReportDatalist">
                                                <?php foreach ($students_for_enrollment as $student): ?>
                                                    <option value="<?= htmlspecialchars($student["lastname"] . ', ' . $student["firstname"] . ' (' . $student["student_id"] . ')') ?>" data-value="<?= htmlspecialchars($student["student_id"]) ?>">
                                                    </option>
                                                <?php endforeach; ?>
                                            </datalist>
                                            <input type="hidden" name="report_student_id" id="report_student_id_input">
                                        </div>
                                        <button type="submit" class="btn btn-submit" style="width: 100%;">Generate Student Report</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="report-content">
                        <div class="report-header">
                            <img src="../images/logowmsu.jpg" alt="WMSU Logo">
                            <h2>Digital Class Recitation Report</h2>
                            <p>Western Mindanao State University</p>
                        </div>
                            
                        <?php if (!empty($report_class_name) && $report_class_details): ?>
                            <h1 class="section-title" style="text-align: left; border: none; padding-bottom: 0; margin-bottom: 10px;">
                                Class Report: <?= htmlspecialchars($report_class_details['class_name']) ?>
                            </h1>
                            <h3 style="text-align: left; margin-top: 0; color: #555; font-weight: normal;">
                                Subject: <?= htmlspecialchars($report_class_details['subject_name_display'] . ' (' . $report_class_details['subject_code'] . ')') ?>
                            </h3>

                            <?php
                                $total_students = count($report_students);
                                $class_avg_score = 0;
                                if ($total_students > 0) {
                                    $total_score = 0;
                                    foreach ($report_students as $student) { $total_score += $student['averageScore']; }
                                    $class_avg_score = $total_score / $total_students;
                                }
                            ?>

                            <div class="report-summary-grid">
                                <div class="report-summary-box"><h4>Total Students</h4><p><?= $total_students ?></p></div>
                                 <div class="report-summary-box"><h4>Class Average Score</h4><p><?= number_format($class_avg_score, 2) ?> / <?= $maxScore ?></p></div>
                            </div>

                            <h3>Student Performance Details</h3>
                            <table>
                                <thead><tr><th>Student ID</th><th>Last Name</th><th>First Name</th><th class="text-center">Total Recitations</th><th class="text-right">Average Score</th></tr></thead>
                                <tbody>
                                    <?php foreach ($report_students as $student): ?>
                                    <tr>
                                        <td><?= htmlspecialchars($student["student_id"]) ?></td>
                                        <td><?= htmlspecialchars($student["lastname"]) ?></td>
                                        <td><?= htmlspecialchars($student["firstname"]) ?></td>
                                        <td class="text-center"><?= htmlspecialchars($student["totalRecitations"]) ?></td>
                                        <td class="text-right"><?= number_format($student["averageScore"], 2) ?></td>
                                    </tr>
                                    <?php endforeach; ?>
                                </tbody>
                            </table>
                            
                        <?php elseif (!empty($report_student_id) && $report_student_details): ?>
                            <h1 class="section-title" style="text-align: left; border: none; padding-bottom: 0; margin-bottom: 10px;">
                                Student Report: <?= htmlspecialchars($report_student_details['lastname'] . ', ' . $report_student_details['firstname']) ?>
                            </h1>
                            <h3 style="text-align: left; margin-top: 0; color: #555; font-weight: normal;">
                                ID: <?= htmlspecialchars($report_student_details['student_id']) ?> | Course: <?= htmlspecialchars($report_student_details['course_name'] ?? 'N/A') ?>
                            </h3>
                            
                            <?php if (empty($report_student_subjects)): ?>
                                <p class="no-records">This student is not yet enrolled in any subjects.</p>
                            <?php else: ?>
                                <?php foreach($report_student_subjects as $subject): ?>
                                    <div class="report-student-subject-header">
                                        <h4><?= htmlspecialchars($subject['subject_name'] . ' (' . $subject['subject_code'] . ')') ?></h4>
                                        <p>Class Section: <?= htmlspecialchars($subject['class_name']) ?></p>
                                    </div>
                                    <?php if (empty($subject['recitations'])): ?>
                                        <p class="no-records" style="margin-top: 10px;">No recitations found for this subject.</p>
                                    <?php else: ?>
                                        <table>
                                            <thead><tr><th>Date</th><th class="text-center">Score</th><th>Mode</th></tr></thead>
                                            <tbody>
                                                <?php foreach ($subject['recitations'] as $rec): ?>
                                                    <tr>
                                                        <td><?= htmlspecialchars(date('M d, Y h:i A', strtotime($rec['date']))) ?></td>
                                                        <td class="text-center"><?= htmlspecialchars($rec['score']) ?> / <?= $maxScore ?></td>
                                                        <td><?= htmlspecialchars(ucfirst($rec['mode'])) ?></td>
                                                    </tr>
                                                <?php endforeach; ?>
                                            </tbody>
                                        </table>
                                    <?php endif; ?>
                                <?php endforeach; ?>
                            <?php endif; ?>

                        <?php elseif ($report_class_name || $report_student_id): ?>
                             <p class="no-records">No data found for the selected criteria.</p>
                        <?php else: ?>
                            <p class="no-records">Please select a class or student from the options above to generate a report.</p>
                        <?php endif; ?>
                        
                        <?php if ((!empty($report_class_name) && $report_class_details) || (!empty($report_student_id) && $report_student_details)): ?>
                        <div style="text-align: center; margin-top: 30px;" id="printReportButton">
                             <button type="button" class="btn btn-print" onclick="window.print()"><span class="material-icons" style="vertical-align: middle; margin-right: 5px;">print</span>Print Report</button>
                        </div>
                        <?php endif; ?>
                    </div>
                </div>

            <?php elseif ($current_section === 'delete_student'): ?>
                 <div class="form-container"><h1 class="section-title">Delete Student</h1><hr class="form-separator"><?php if (isset($_GET['delete_success'])): ?><p class="success-message">Student successfully deleted!</p><?php endif; ?><?php if (!empty($add_student_errors['general_delete'])): ?><p class="error-message">Error: <?= htmlspecialchars($add_student_errors['general_delete']) ?></p><?php endif; ?><form action="" method="post" id="deleteStudentInitialForm"><div class="form-group"><label for="studentToDelete">Select Student to Delete</label><select id="studentToDelete" name="studentIdToDelete" required><option value="">-- Select Student ID --</option><?php foreach ($students_for_enrollment as $student): ?><option value="<?= htmlspecialchars($student["student_id"]) ?>" data-name="<?= htmlspecialchars($student["lastname"] . ', ' . $student["firstname"]) ?>"><?= htmlspecialchars($student["student_id"] . " - " . $student["lastname"] . ", " . $student["firstname"]) ?> (Enrolled: <?= $student['total_subjects_enrolled'] ?>)</option><?php endforeach; ?></select></div><div class="form-group"><label for="deletion_reason">Reason for Removal (Optional)</label><textarea name="deletion_reason" id="deletion_reason" rows="3"></textarea><small>This reason is not currently stored.</small></div><button type="button" id="initiateDeleteButton" class="btn btn-delete">Delete Student</button></form><?php if (empty($students_for_enrollment)): ?><p class="no-records">No students available to delete.</p><?php endif; ?></div>
            <?php endif; ?>
        </main>
    </div>

     <div id="deleteConfirmModal" class="modal"><div class="modal-content"><span class="modal-close-button">&times;</span><h3>Confirm Deletion</h3><div class="modal-body"><p>Are you absolutely sure you want to permanently delete the following student?</p><p><strong id="deleteStudentName"></strong><br>(ID: <span id="deleteStudentId"></span>)</p><p style="color: #D32F2F; font-weight: bold;">This action cannot be undone.</p></div><div class="modal-footer"><form action="" method="post" id="deleteConfirmForm" style="display: inline;"><input type="hidden" name="form_action" value="confirm_delete_student"><input type="hidden" name="studentIdToDeleteConfirmed" id="studentIdToDeleteConfirmed"><button type="submit" class="btn btn-delete">Confirm Delete</button></form><button type="button" class="btn btn-cancel" id="cancelDeleteButton">Cancel</button></div></div></div>
     <div id="withdrawModal" class="modal"><div class="modal-content"><span class="modal-close-button">&times;</span><h3>Withdraw Student</h3><form action="" method="post" id="withdrawConfirmForm"><div class="modal-body"><p>Are you sure you want to withdraw <strong id="withdrawStudentName"></strong> from the class <strong id="withdrawClassName"></strong>?</p><div class="form-group" style="text-align: left;"><label for="withdraw_reason">Reason for Withdrawal (Required):</label><textarea name="withdraw_reason" id="withdraw_reason" rows="3" style="width: 100%; box-sizing: border-box;" required></textarea><span class="form-error" id="withdraw_reason_error"></span></div></div><div class="modal-footer"><input type="hidden" name="form_action" value="withdraw_student"><input type="hidden" name="student_id_to_withdraw" id="student_id_to_withdraw"><input type="hidden" name="class_id_to_withdraw" id="class_id_to_withdraw"><button type="submit" class="btn btn-delete">Confirm Withdraw</button><button type="button" class="btn btn-cancel" id="cancelWithdrawButton">Cancel</button></div></form></div></div>
     <div id="deleteClassModal" class="modal"><div class="modal-content"><span class="modal-close-button">&times;</span><h3>Confirm Class Deletion</h3><div class="modal-body"><p>Are you sure you want to delete the class <strong id="deleteClassName"></strong>?</p><p style="color: #D32F2F; font-weight: bold;">This will un-enroll all students from this class. This action cannot be undone.</p></div><div class="modal-footer"><form action="" method="post" id="deleteClassConfirmForm" style="display: inline;"><input type="hidden" name="form_action" value="confirm_delete_class"><input type="hidden" name="class_id_to_delete_confirmed" id="class_id_to_delete_confirmed"><button type="submit" class="btn btn-delete">Confirm Delete</button></form><button type="button" class="btn btn-cancel" id="cancelDeleteClassButton">Cancel</button></div></div></div>
     <div id="deleteCourseModal" class="modal"><div class="modal-content"><span class="modal-close-button">&times;</span><h3>Confirm Course Deletion</h3><div class="modal-body"><p>Are you sure you want to delete the course <strong id="deleteCourseName"></strong>?</p><p style="color: #D32F2F; font-weight: bold;">This may fail if students are enrolled in this course. This action cannot be undone.</auto-fill></div><div class="modal-footer"><form action="" method="post" id="deleteCourseConfirmForm" style="display: inline;"><input type="hidden" name="form_action" value="confirm_delete_course"><input type="hidden" name="course_id_to_delete_confirmed" id="course_id_to_delete_confirmed"><button type="submit" class="btn btn-delete">Confirm Delete</button></form><button type="button" class="btn btn-cancel" id="cancelDeleteCourseButton">Cancel</button></div></div></div>
     <div id="deleteSubjectModal" class="modal"><div class="modal-content"><span class="modal-close-button">&times;</span><h3>Confirm Subject Deletion</h3><div class="modal-body"><p>Are you sure you want to delete the subject <strong id="deleteSubjectName"></strong>?</p><p style="color: #D32F2F; font-weight: bold;">This may fail if this subject is used by any class sections. This action cannot be undone.</all></div><div class="modal-footer"><form action="" method="post" id="deleteSubjectConfirmForm" style="display: inline;"><input type="hidden" name="form_action" value="confirm_delete_subject"><input type="hidden" name="subject_code_to_delete_confirmed" id="subject_code_to_delete_confirmed"><button type="submit" class="btn btn-delete">Confirm Delete</button></form><button type="button" class="btn btn-cancel" id="cancelDeleteSubjectButton">Cancel</button></div></div></div>

    <script>
        const allStudents = JSON.parse('<?= $students_json ?>');
        const maxScore = <?= $maxScore ?>;
        const maxRecitations = <?= $totalPossibleRecitations ?? 10 ?>;
        const resultDisplay = document.getElementById('result-display');
        const scoreModal = document.getElementById('scoreModal');
        const randomizerControl = document.getElementById('randomizer-control');
        const pickerToggleButton = document.getElementById('picker-toggle-button');
        const closeButton = scoreModal ? scoreModal.querySelector('.close-button') : null;
        
        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        const initiateDeleteButton = document.getElementById('initiateDeleteButton');
        const cancelDeleteButton = document.getElementById('cancelDeleteButton');
        const deleteModalCloseButton = deleteConfirmModal ? deleteConfirmModal.querySelector('.modal-close-button') : null;
        const studentToDeleteSelect = document.getElementById('studentToDelete');
        
        const withdrawModal = document.getElementById('withdrawModal');
        const cancelWithdrawButton = document.getElementById('cancelWithdrawButton');
        const withdrawModalCloseButton = withdrawModal ? withdrawModal.querySelector('.modal-close-button') : null;
        const withdrawConfirmForm = document.getElementById('withdrawConfirmForm');
        const withdrawReasonInput = document.getElementById('withdraw_reason');
        const withdrawReasonError = document.getElementById('withdraw_reason_error');

        const deleteClassModal = document.getElementById('deleteClassModal');
        const initiateDeleteClassButton = document.getElementById('initiateDeleteClassButton');
        const cancelDeleteClassButton = document.getElementById('cancelDeleteClassButton');
        const deleteClassModalCloseButton = deleteClassModal ? deleteClassModal.querySelector('.modal-close-button') : null;
        const classToDeleteSelect = document.getElementById('classIdToDelete');
        
        const deleteCourseModal = document.getElementById('deleteCourseModal');
        const initiateDeleteCourseButton = document.getElementById('initiateDeleteCourseButton');
        const cancelDeleteCourseButton = document.getElementById('cancelDeleteCourseButton');
        const deleteCourseModalCloseButton = deleteCourseModal ? deleteCourseModal.querySelector('.modal-close-button') : null;
        const courseToDeleteSelect = document.getElementById('courseIdToDelete');

        const deleteSubjectModal = document.getElementById('deleteSubjectModal');
        const initiateDeleteSubjectButton = document.getElementById('initiateDeleteSubjectButton');
        const cancelDeleteSubjectButton = document.getElementById('cancelDeleteSubjectButton');
        const deleteSubjectModalCloseButton = deleteSubjectModal ? deleteSubjectModal.querySelector('.modal-close-button') : null;
        const subjectToDeleteSelect = document.getElementById('subjectCodeToDelete');

        function togglePicker() {
            if (!randomizerControl) return;
            const isHidden = randomizerControl.style.display === 'none' || randomizerControl.style.display === '';
            randomizerControl.style.display = isHidden ? 'block' : 'none';
             if(pickerToggleButton) {
                pickerToggleButton.innerHTML = isHidden
                    ? '<span class="material-icons" style="vertical-align: middle; margin-right: 5px;">close</span>Hide Picker'
                    : '<span class="material-icons" style="vertical-align: middle; margin-right: 5px;">touch_app</span>Pick a Student for Recitation';
             }
            if (!isHidden && resultDisplay) {
                resultDisplay.innerHTML = "Click a button to pick a student.";
                resultDisplay.style.color = 'inherit';
            }
        }
        function getStudentFullName(student) {
            let fullName = student.firstname + ' ';
            if (student.middlename) { fullName += student.middlename.charAt(0) + '. '; }
            fullName += student.lastname;
            return fullName;
        }
        function openScoreModal(student, mode) {
            if (!scoreModal) return;
            document.getElementById('modal-student-name').textContent = getStudentFullName(student) + ' (' + (student.class_name || 'N/A') + ')';
            document.getElementById('modal-student-id-display').textContent = student.student_id;
            document.getElementById('modal-mode').textContent = mode;
            document.getElementById('modal-student-id').value = student.student_id;
            document.getElementById('modal-mode-input').value = mode;
            document.getElementById('modal-subject-code-input').value = student.subject_code || '';
            document.getElementById('modal-score').value = '';
            document.getElementById('modal-score').setAttribute('max', maxScore);
            scoreModal.style.display = 'flex';
        }
        window.handleScoreButtonClick = function(studentId, mode) {
            const student = allStudents.find(s => s.student_id == studentId);
             if (student && student.subject_code) {
                openScoreModal(student, mode);
            } else if (student && !student.subject_code) {
                alert("Error: Cannot record score. Student '" + getStudentFullName(student) + "' is not assigned to a class/subject.");
            } else {
                alert("Error: Student data missing.");
            }
        }
        const pickerButtons = document.querySelectorAll('.btn-picker');
        if (pickerButtons) {
            pickerButtons.forEach(button => {
                button.addEventListener('click', (event) => {
                     if(resultDisplay) resultDisplay.innerHTML = '<span class="material-icons" style="font-size: 2em; animation: spin 1s linear infinite;">hourglass_empty</span> Picking...';
                    const mode = event.target.closest('button').dataset.mode;
                    setTimeout(() => pickStudent(mode), 50);
                });
            });
        }

        function pickStudent(mode) {
             if (!resultDisplay) return;
             const enrolledStudents = allStudents.filter(s => s.class_name && s.class_name.trim() !== '' && s.class_name.trim() !== '(Multiple)');
            if (enrolledStudents.length === 0) {
                 resultDisplay.textContent = "No enrolled students available in this class filter!";
                 resultDisplay.style.color = '#D32F2F';
                 return;
             }
            let potentialStudents = enrolledStudents.filter(s => parseInt(s.totalRecitations) < maxRecitations);
             if (potentialStudents.length === 0) {
                 resultDisplay.textContent = "All currently filtered and enrolled students have reached the maximum recitations (" + maxRecitations + ").";
                 resultDisplay.style.color = '#ff9800';
                 return;
             }
            let eligibleStudents = [];
            let pickingRationale = "";
            let rationaleColor = "#555";
            if (mode === 'Fair') {
                eligibleStudents = potentialStudents.filter(s => parseInt(s.totalRecitations) === 0);
                if (eligibleStudents.length === 0) {
                    eligibleStudents = potentialStudents;
                    pickingRationale = `FAIR MODE: All eligible students have recitations. Picking randomly from ${eligibleStudents.length} enrolled student(s) under max recits.`;
                    rationaleColor = '#ff9800';
                } else {
                    pickingRationale = `FAIR MODE: Picking from ${eligibleStudents.length} enrolled student(s) with 0 recitations.`;
                    rationaleColor = '#28a745';
                }
            } else {
                eligibleStudents = potentialStudents;
                pickingRationale = `NORMAL MODE: Picking randomly from ${eligibleStudents.length} enrolled student(s) under max recits.`;
                rationaleColor = '#555';
            }
             if (eligibleStudents.length === 0) { resultDisplay.textContent = "No eligible students found for this mode after filtering!"; resultDisplay.style.color = '#D32F2F'; return; }
            const randomIndex = Math.floor(Math.random() * eligibleStudents.length);
            const pickedStudent = eligibleStudents[randomIndex];
            resultDisplay.style.color = rationaleColor;
            resultDisplay.textContent = pickingRationale;
            setTimeout(() => {
                if (!pickedStudent || !resultDisplay) return;
                resultDisplay.style.color = '#333';
                resultDisplay.innerHTML = `
                    <div style="text-align: center;">
                        <strong>PICKED:</strong><br>
                         <span style="color: #D32F2F; font-size: 1.3em;"><strong>${getStudentFullName(pickedStudent)}</strong></span><br>
                        <span style="color: #555;">(${pickedStudent.class_name || 'N/A'}) - ID: ${pickedStudent.student_id}</span><br>
                        <small>Current Recitations: ${pickedStudent.totalRecitations} / ${maxRecitations}</small>
                        <br>
                        <button onclick="handleScoreButtonClick('${pickedStudent.student_id}', '${mode}')" class="btn btn-record" ${!pickedStudent.subject_code ? 'disabled title="Student not assigned to a class/subject"' : ''}>
                             <span class="material-icons" style="vertical-align: middle; font-size: 1.1em;">note_add</span> Record Score
                        </button>
                    </div>`;
            }, 700);
        }
        if (closeButton) { closeButton.addEventListener('click', () => scoreModal.style.display = 'none'); }
        window.addEventListener('click', (event) => { if (event.target == scoreModal) { scoreModal.style.display = 'none'; } });

        if (initiateDeleteButton && deleteConfirmModal && studentToDeleteSelect) {
            initiateDeleteButton.addEventListener('click', function() {
                const selectedOption = studentToDeleteSelect.options[studentToDeleteSelect.selectedIndex];
                const studentId = selectedOption.value;
                const studentName = selectedOption.dataset.name || studentId;
                if (!studentId) { alert("Please select a student to delete."); return; }
                document.getElementById('deleteStudentName').textContent = studentName;
                document.getElementById('deleteStudentId').textContent = studentId;
                document.getElementById('studentIdToDeleteConfirmed').value = studentId;
                deleteConfirmModal.style.display = 'flex';
            });
        }
        if (cancelDeleteButton) { cancelDeleteButton.addEventListener('click', () => { deleteConfirmModal.style.display = 'none'; }); }
        if (deleteModalCloseButton) { deleteModalCloseButton.addEventListener('click', () => { deleteConfirmModal.style.display = 'none'; }); }
        window.addEventListener('click', (event) => { if (event.target == deleteConfirmModal) { deleteConfirmModal.style.display = 'none'; } });

         if(pickerToggleButton && randomizerControl) {
            pickerToggleButton.addEventListener('click', togglePicker);
             randomizerControl.style.display = 'none';
             pickerToggleButton.innerHTML = '<span class="material-icons" style="vertical-align: middle; margin-right: 5px;">touch_app</span>Pick a Student for Recitation';
         }
         
         document.querySelectorAll('.btn-withdraw').forEach(button => {
            button.addEventListener('click', function() {
                const studentId = this.dataset.studentid;
                const classId = this.dataset.classid;
                const studentName = this.dataset.studentname;
                const className = this.dataset.classname;
                if (!studentId || !classId) { alert("Error: Missing student or class information."); return; }
                document.getElementById('withdrawStudentName').textContent = studentName;
                document.getElementById('withdrawClassName').textContent = className;
                document.getElementById('student_id_to_withdraw').value = studentId;
                document.getElementById('class_id_to_withdraw').value = classId;
                document.getElementById('withdraw_reason').value = '';
                document.getElementById('withdraw_reason_error').textContent = '';
                withdrawModal.style.display = 'flex';
            });
         });

         if (withdrawConfirmForm) {
            withdrawConfirmForm.addEventListener('submit', function(event) {
                if (withdrawReasonInput.value.trim() === '') {
                    event.preventDefault(); 
                    withdrawReasonError.textContent = 'A reason for withdrawal is required.';
                } else {
                     withdrawReasonError.textContent = '';
                }
            });
         }
         if (cancelWithdrawButton) { cancelWithdrawButton.addEventListener('click', () => { withdrawModal.style.display = 'none'; }); }
         if (withdrawModalCloseButton) { withdrawModalCloseButton.addEventListener('click', () => { withdrawModal.style.display = 'none'; }); }
         window.addEventListener('click', (event) => { if (event.target == withdrawModal) { withdrawModal.style.display = 'none'; } });
         
         if (initiateDeleteClassButton && deleteClassModal && classToDeleteSelect) {
            initiateDeleteClassButton.addEventListener('click', function() {
                const selectedOption = classToDeleteSelect.options[classToDeleteSelect.selectedIndex];
                const classId = selectedOption.value;
                const className = selectedOption.dataset.name || 'this class';
                if (!classId) { alert("Please select a class section to delete."); return; }
                document.getElementById('deleteClassName').textContent = className;
                document.getElementById('class_id_to_delete_confirmed').value = classId;
                deleteClassModal.style.display = 'flex';
            });
         }
         if (cancelDeleteClassButton) { cancelDeleteClassButton.addEventListener('click', () => { deleteClassModal.style.display = 'none'; }); }
         if (deleteClassModalCloseButton) { deleteClassModalCloseButton.addEventListener('click', () => { deleteClassModal.style.display = 'none'; }); }
         window.addEventListener('click', (event) => { if (event.target == deleteClassModal) { deleteClassModal.style.display = 'none'; } });
         
         if (initiateDeleteCourseButton && deleteCourseModal && courseToDeleteSelect) {
            initiateDeleteCourseButton.addEventListener('click', function() {
                const selectedOption = courseToDeleteSelect.options[courseToDeleteSelect.selectedIndex];
                const courseId = selectedOption.value;
                const courseName = selectedOption.dataset.name || 'this course';
                if (!courseId) { alert("Please select a course to delete."); return; }
                document.getElementById('deleteCourseName').textContent = courseName;
                document.getElementById('course_id_to_delete_confirmed').value = courseId;
                deleteCourseModal.style.display = 'flex';
            });
         }
         if (cancelDeleteCourseButton) { cancelDeleteCourseButton.addEventListener('click', () => { deleteCourseModal.style.display = 'none'; }); }
         if (deleteCourseModalCloseButton) { deleteCourseModalCloseButton.addEventListener('click', () => { deleteCourseModal.style.display = 'none'; }); }
         window.addEventListener('click', (event) => { if (event.target == deleteCourseModal) { deleteCourseModal.style.display = 'none'; } });

         if (initiateDeleteSubjectButton && deleteSubjectModal && subjectToDeleteSelect) {
            initiateDeleteSubjectButton.addEventListener('click', function() {
                const selectedOption = subjectToDeleteSelect.options[subjectToDeleteSelect.selectedIndex];
                const subjectCode = selectedOption.value;
                const subjectName = selectedOption.dataset.name || 'this subject';
                if (!subjectCode) { alert("Please select a subject to delete."); return; }
                document.getElementById('deleteSubjectName').textContent = subjectName;
                document.getElementById('subject_code_to_delete_confirmed').value = subjectCode;
                deleteSubjectModal.style.display = 'flex';
            });
         }
         if (cancelDeleteSubjectButton) { cancelDeleteSubjectButton.addEventListener('click', () => { deleteSubjectModal.style.display = 'none'; }); }
         if (deleteSubjectModalCloseButton) { deleteSubjectModalCloseButton.addEventListener('click', () => { deleteSubjectModal.style.display = 'none'; }); }
         window.addEventListener('click', (event) => { if (event.target == deleteSubjectModal) { deleteSubjectModal.style.display = 'none'; } });

         const studentSearchInput = document.getElementById('studentSearchInput');
         const studentIdToEnrollInput = document.getElementById('studentIdToEnroll');
         const studentDatalist = document.getElementById('studentDatalist');

         if (studentSearchInput && studentIdToEnrollInput && studentDatalist) {
            studentSearchInput.addEventListener('input', function() {
                const inputValue = this.value;
                studentIdToEnrollInput.value = '';
                for (let option of studentDatalist.options) {
                    if (option.value === inputValue) {
                        studentIdToEnrollInput.value = option.dataset.value;
                        break;
                    }
                }
            });
            studentSearchInput.addEventListener('change', function() {
                if (studentIdToEnrollInput.value === '') {
                    if (this.value !== '') {
                        alert('Please select a valid student from the list.');
                        this.value = '';
                    }
                }
            });
         }
         
         const studentReportSearch = document.getElementById('studentReportSearch');
         const studentReportIdInput = document.getElementById('report_student_id_input');
         const studentReportDatalist = document.getElementById('studentReportDatalist');

         if (studentReportSearch && studentReportIdInput && studentReportDatalist) {
            studentReportSearch.addEventListener('input', function() {
                const inputValue = this.value;
                studentReportIdInput.value = '';
                for (let option of studentReportDatalist.options) {
                    if (option.value === inputValue) {
                        studentReportIdInput.value = option.dataset.value;
                        break;
                    }
                }
            });
             studentReportSearch.addEventListener('change', function() {
                if (studentReportIdInput.value === '') {
                    if (this.value !== '') {
                        alert('Please select a valid student from the list.');
                        this.value = '';
                    }
                }
            });
         }

         // Initialize Charts (Only if on dashboard)
         const ctxEngagement = document.getElementById('engagementChart');
         const ctxSubject = document.getElementById('subjectChart');

         if (ctxEngagement) {
             const engagedCount = <?= $chart_engaged ?>;
             const totalCount = <?= $chart_total ?>;
             const notEngagedCount = totalCount - engagedCount;

             new Chart(ctxEngagement, {
                 type: 'doughnut',
                 data: {
                     labels: ['Engaged Students', 'Not Engaged'],
                     datasets: [{
                         data: [engagedCount, notEngagedCount],
                         backgroundColor: ['#4CAF50', '#EEEEEE'],
                         hoverOffset: 4
                     }]
                 },
                 options: { responsive: true }
             });
         }

         if (ctxSubject) {
             const labels = <?= $chart_labels_json ?>;
             const data = <?= $chart_data_json ?>;

             new Chart(ctxSubject, {
                 type: 'bar',
                 data: {
                     labels: labels,
                     datasets: [{
                         label: 'Recitations',
                         data: data,
                         backgroundColor: '#D32F2F',
                         borderColor: '#B71C1C',
                         borderWidth: 1
                     }]
                 },
                 options: {
                     responsive: true,
                     scales: {
                         y: { beginAtZero: true, ticks: { stepSize: 1 } }
                     }
                 }
             });
         }
    </script>
</body>
</html>